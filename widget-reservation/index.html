<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©servation ‚Äî Le Rebond</title>
    <link rel="canonical" href="https://le-rebond.fr/widget-reservation/">
    <meta property="og:site_name" content="Le Rebond">
    <meta property="og:type" content="website">
    <meta property="og:title" content="R√©servation ‚Äî Le Rebond">
    <meta property="og:description" content="">
    <meta property="og:url" content="https://le-rebond.fr/widget-reservation/">
    <meta property="og:image" content="https://le-rebond.fr/img/og-cover.png">
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="R√©servation ‚Äî Le Rebond">
    <meta name="twitter:description" content="">
    <meta name="twitter:image" content="https://le-rebond.fr/img/og-cover.png">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* ============================================
           RESERVATION WIDGET ‚Äî LE REBOND
           ============================================ */
        
        :root {
            --primary: #1B998B;
            --primary-dark: #158578;
            --primary-light: #2BC4B4;
            --accent: #E8C547;
            --dark: #0D1117;
            --dark-card: #161B22;
            --dark-input: #1C2333;
            --dark-border: #2D333B;
            --text: #E6EDF3;
            --text-muted: #8B949E;
            --text-dim: #6E7681;
            --danger: #F85149;
            --success: #3FB950;
            --radius: 12px;
            --radius-sm: 8px;
            --shadow: 0 8px 32px rgba(0,0,0,0.3);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: 'Outfit', -apple-system, sans-serif;
            background: var(--dark);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 20px;
        }

        /* Container principal */
        .resa-widget {
            width: 100%;
            max-width: 480px;
            background: var(--dark-card);
            border: 1px solid var(--dark-border);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        /* Header */
        .resa-header {
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary) 50%, var(--primary-light) 100%);
            padding: 28px 24px 24px;
            position: relative;
            overflow: hidden;
        }
        .resa-header::before {
            content: '';
            position: absolute;
            top: -40px; right: -40px;
            width: 120px; height: 120px;
            background: rgba(255,255,255,0.08);
            border-radius: 50%;
        }
        .resa-header::after {
            content: '';
            position: absolute;
            bottom: -20px; left: 30%;
            width: 80px; height: 80px;
            background: rgba(255,255,255,0.05);
            border-radius: 50%;
        }
        .resa-header h1 {
            font-family: 'Space Mono', monospace;
            font-size: 13px;
            font-weight: 700;
            letter-spacing: 3px;
            text-transform: uppercase;
            color: rgba(255,255,255,0.7);
            margin-bottom: 6px;
        }
        .resa-header h2 {
            font-size: 26px;
            font-weight: 700;
            color: #fff;
            line-height: 1.2;
        }
        .resa-header p {
            margin-top: 8px;
            font-size: 14px;
            color: rgba(255,255,255,0.7);
            font-weight: 300;
        }

        /* Stepper */
        .resa-steps {
            display: flex;
            gap: 4px;
            padding: 16px 24px;
            background: var(--dark);
        }
        .step-dot {
            flex: 1;
            height: 3px;
            border-radius: 2px;
            background: var(--dark-border);
            transition: background 0.4s ease;
        }
        .step-dot.active { background: var(--primary); }
        .step-dot.done { background: var(--primary-light); }

        /* Corps */
        .resa-body {
            padding: 24px;
        }

        /* Sections / √©tapes */
        .resa-step {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        .resa-step.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Labels */
        .field-label {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            color: var(--text-muted);
            margin-bottom: 10px;
            display: block;
        }

        /* S√©lecteur de personnes */
        .person-selector {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 24px;
        }
        .person-btn {
            width: 52px; height: 52px;
            border-radius: var(--radius-sm);
            border: 1.5px solid var(--dark-border);
            background: var(--dark-input);
            color: var(--text);
            font-family: 'Outfit', sans-serif;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .person-btn:hover {
            border-color: var(--primary);
            background: rgba(27, 153, 139, 0.1);
        }
        .person-btn.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: #fff;
            box-shadow: 0 0 20px rgba(27, 153, 139, 0.3);
        }

        /* Calendrier compact */
        .date-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 24px;
        }
        .date-grid-header {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 4px;
            margin-bottom: 8px;
        }
        .day-name {
            text-align: center;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .date-btn {
            aspect-ratio: 1;
            border-radius: var(--radius-sm);
            border: 1.5px solid transparent;
            background: var(--dark-input);
            color: var(--text);
            font-family: 'Outfit', sans-serif;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .date-btn:hover:not(.disabled):not(.empty) {
            border-color: var(--primary);
            background: rgba(27, 153, 139, 0.1);
        }
        .date-btn.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: #fff;
        }
        .date-btn.today {
            border-color: var(--accent);
            color: var(--accent);
            font-weight: 700;
        }
        .date-btn.today.selected {
            background: var(--primary);
            border-color: var(--primary);
            color: #fff;
        }
        .date-btn.disabled {
            color: var(--text-dim);
            opacity: 0.3;
            cursor: not-allowed;
        }
        .date-btn.empty {
            background: transparent;
            cursor: default;
        }

        .month-nav {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }
        .month-nav span {
            font-size: 16px;
            font-weight: 600;
        }
        .month-nav button {
            width: 36px; height: 36px;
            border-radius: 50%;
            border: 1.5px solid var(--dark-border);
            background: var(--dark-input);
            color: var(--text);
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .month-nav button:hover {
            border-color: var(--primary);
            background: rgba(27, 153, 139, 0.1);
        }

        /* Cr√©neaux horaires */
        .service-label {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-muted);
            margin: 16px 0 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .service-label::after {
            content: '';
            flex: 1;
            height: 1px;
            background: var(--dark-border);
        }

        .time-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 8px;
        }
        .time-btn {
            padding: 12px 8px;
            border-radius: var(--radius-sm);
            border: 1.5px solid var(--dark-border);
            background: var(--dark-input);
            color: var(--text);
            font-family: 'Outfit', sans-serif;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: center;
        }
        .time-btn:hover { border-color: var(--primary); }
        .time-btn.selected {
            border-color: var(--primary);
            background: var(--primary);
            color: #fff;
        }
        .time-btn .places {
            font-size: 11px;
            color: var(--text-dim);
            margin-top: 2px;
        }
        .time-btn.selected .places { color: rgba(255,255,255,0.7); }
        .time-btn.low .places { color: var(--accent); }
        .time-btn.full {
            opacity: 0.3;
            cursor: not-allowed;
            text-decoration: line-through;
        }

        /* Formulaire */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        .form-group {
            margin-bottom: 16px;
        }
        .form-group.full { grid-column: 1 / -1; }
        .form-group label {
            display: block;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            margin-bottom: 6px;
            letter-spacing: 0.5px;
        }
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 12px 14px;
            border-radius: var(--radius-sm);
            border: 1.5px solid var(--dark-border);
            background: var(--dark-input);
            color: var(--text);
            font-family: 'Outfit', sans-serif;
            font-size: 14px;
            transition: border-color 0.2s ease;
            outline: none;
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            border-color: var(--primary);
        }
        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: var(--text-dim);
        }
        .form-group textarea {
            resize: vertical;
            min-height: 70px;
        }
        .form-group select option {
            background: var(--dark-card);
        }

        /* Boutons navigation */
        .resa-nav {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }
        .btn {
            flex: 1;
            padding: 14px 20px;
            border-radius: var(--radius);
            font-family: 'Outfit', sans-serif;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            text-align: center;
        }
        .btn-primary {
            background: var(--primary);
            color: #fff;
        }
        .btn-primary:hover { background: var(--primary-light); }
        .btn-primary:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        .btn-secondary {
            background: var(--dark-input);
            color: var(--text-muted);
            border: 1.5px solid var(--dark-border);
        }
        .btn-secondary:hover {
            border-color: var(--text-dim);
            color: var(--text);
        }

        /* R√©cap */
        .recap-card {
            background: var(--dark);
            border: 1px solid var(--dark-border);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
        }
        .recap-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
        }
        .recap-row:not(:last-child) {
            border-bottom: 1px solid var(--dark-border);
        }
        .recap-label {
            font-size: 13px;
            color: var(--text-muted);
        }
        .recap-value {
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }

        /* Confirmation finale */
        .confirmation {
            text-align: center;
            padding: 20px 0;
        }
        .confirmation-icon {
            width: 72px; height: 72px;
            border-radius: 50%;
            background: rgba(63, 185, 80, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 36px;
        }
        .confirmation h3 {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        .confirmation p {
            color: var(--text-muted);
            font-size: 14px;
            line-height: 1.5;
        }

        /* Error */
        .error-msg {
            background: rgba(248, 81, 73, 0.1);
            border: 1px solid rgba(248, 81, 73, 0.3);
            border-radius: var(--radius-sm);
            padding: 12px 16px;
            color: var(--danger);
            font-size: 13px;
            margin-bottom: 16px;
            display: none;
        }
        .error-msg.visible { display: block; }

        /* Loading */
        .loading-overlay {
            display: none;
            position: absolute;
            inset: 0;
            background: rgba(13, 17, 23, 0.8);
            z-index: 10;
            align-items: center;
            justify-content: center;
            border-radius: 16px;
        }
        .loading-overlay.visible { display: flex; }
        .spinner {
            width: 40px; height: 40px;
            border: 3px solid var(--dark-border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* No slots message */
        .no-slots {
            text-align: center;
            padding: 24px;
            color: var(--text-muted);
            font-size: 14px;
        }
        .no-slots svg {
            width: 48px; height: 48px;
            margin-bottom: 12px;
            opacity: 0.3;
        }

        /* Responsive */
        @media (max-width: 480px) {
            body { padding: 0; }
            .resa-widget { border-radius: 0; border: none; min-height: 100vh; }
            .time-grid { grid-template-columns: repeat(3, 1fr); }
        }
    </style>
<script type="application/ld+json">{"@context":"https://schema.org","@type":"SportsActivityLocation","name":"Le Rebond","url":"https://le-rebond.fr/","image":"https://le-rebond.fr/img/og-cover.png","logo":"https://le-rebond.fr/img/logo-8.webp","priceRange":"‚Ç¨","telephone":"+33344000000","address":{"@type":"PostalAddress","streetAddress":"403 Rue de l'Europe","postalCode":"60400","addressLocality":"Noyon","addressCountry":"FR"},"geo":{"@type":"GeoCoordinates","latitude":49.57385,"longitude":3.02572}}</script>
</head>
<body class="">

<div class="resa-widget" style="position: relative">
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- Header -->
    <div class="resa-header">
        <h1>Le Rebond</h1>
        <h2>R√©server une table</h2>
        <p>Bar-restaurant ¬∑ Complexe sportif ¬∑ Noyon</p>
    </div>

    <!-- Steps indicator -->
    <div class="resa-steps">
        <div class="step-dot active" id="dot-0"></div>
        <div class="step-dot" id="dot-1"></div>
        <div class="step-dot" id="dot-2"></div>
        <div class="step-dot" id="dot-3"></div>
    </div>

    <div class="resa-body">
        <div id="errorMsg" class="error-msg"></div>

        <!-- √âTAPE 0 : Nombre de personnes -->
        <div class="resa-step active" id="step-0">
            <label class="field-label">Combien de convives ?</label>
            <div class="person-selector" id="personSelector"></div>
            <div class="resa-nav">
                <button class="btn btn-primary" id="btnNext0" disabled onclick="goStep(1)">Choisir la date ‚Üí</button>
            </div>
        </div>

        <!-- √âTAPE 1 : Date + cr√©neau -->
        <div class="resa-step" id="step-1">
            <label class="field-label">Quelle date ?</label>
            <div class="month-nav">
                <button onclick="changeMonth(-1)" id="prevMonth">‚Äπ</button>
                <span id="monthLabel"></span>
                <button onclick="changeMonth(1)">‚Ä∫</button>
            </div>
            <div class="date-grid-header" id="dayNames"></div>
            <div class="date-grid" id="dateGrid"></div>

            <div id="slotsContainer" style="display: none">
                <label class="field-label" style="margin-top: 20px">Quelle heure ?</label>
                <div id="slotsContent"></div>
            </div>

            <div class="resa-nav">
                <button class="btn btn-secondary" onclick="goStep(0)">‚Üê Retour</button>
                <button class="btn btn-primary" id="btnNext1" disabled onclick="goStep(2)">Vos coordonn√©es ‚Üí</button>
            </div>
        </div>

        <!-- √âTAPE 2 : Coordonn√©es -->
        <div class="resa-step" id="step-2">
            <label class="field-label">Vos informations</label>
            <div class="form-row">
                <div class="form-group">
                    <label>Pr√©nom *</label>
                    <input type="text" id="inputPrenom" placeholder="Jean" required>
                </div>
                <div class="form-group">
                    <label>Nom *</label>
                    <input type="text" id="inputNom" placeholder="Dupont" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Email *</label>
                    <input type="email" id="inputEmail" placeholder="jean@email.com" required>
                </div>
                <div class="form-group">
                    <label>T√©l√©phone *</label>
                    <input type="tel" id="inputTel" placeholder="06 12 34 56 78" required>
                </div>
            </div>
            <div class="form-group">
                <label>Occasion</label>
                <select id="inputOccasion">
                    <option value="">‚Äî Aucune en particulier ‚Äî</option>
                    <option value="anniversaire">üéÇ Anniversaire</option>
                    <option value="affaires">üíº Repas d'affaires</option>
                    <option value="amis">üçª Entre amis</option>
                    <option value="couple">‚ù§Ô∏è En couple</option>
                    <option value="famille">üë®‚Äçüë©‚Äçüëß‚Äçüë¶ En famille</option>
                    <option value="sport">üéæ Apr√®s le sport</option>
                    <option value="autre">Autre</option>
                </select>
            </div>
            <div class="form-group">
                <label>Commentaire / Allergies</label>
                <textarea id="inputComment" placeholder="Allergies, demandes sp√©ciales, placement pr√©f√©r√©..."></textarea>
            </div>
            <div class="resa-nav">
                <button class="btn btn-secondary" onclick="goStep(1)">‚Üê Retour</button>
                <button class="btn btn-primary" id="btnNext2" onclick="goStep(3)">Confirmer ‚Üí</button>
            </div>
        </div>

        <!-- √âTAPE 3 : R√©capitulatif + Confirmation -->
        <div class="resa-step" id="step-3">
            <div id="recapView">
                <label class="field-label">R√©capitulatif</label>
                <div class="recap-card">
                    <div class="recap-row">
                        <span class="recap-label">Convives</span>
                        <span class="recap-value" id="recapPersonnes"></span>
                    </div>
                    <div class="recap-row">
                        <span class="recap-label">Date</span>
                        <span class="recap-value" id="recapDate"></span>
                    </div>
                    <div class="recap-row">
                        <span class="recap-label">Heure</span>
                        <span class="recap-value" id="recapHeure"></span>
                    </div>
                    <div class="recap-row">
                        <span class="recap-label">Nom</span>
                        <span class="recap-value" id="recapNom"></span>
                    </div>
                    <div class="recap-row">
                        <span class="recap-label">Email</span>
                        <span class="recap-value" id="recapEmail"></span>
                    </div>
                    <div class="recap-row">
                        <span class="recap-label">T√©l√©phone</span>
                        <span class="recap-value" id="recapTel"></span>
                    </div>
                </div>
                <div class="resa-nav">
                    <button class="btn btn-secondary" onclick="goStep(2)">‚Üê Modifier</button>
                    <button class="btn btn-primary" id="btnConfirm" onclick="submitReservation()">‚úì Confirmer</button>
                </div>
            </div>

            <div id="confirmView" style="display: none">
                <div class="confirmation">
                    <div class="confirmation-icon">‚úì</div>
                    <h3>R√©servation confirm√©e !</h3>
                    <p>Un email de confirmation a √©t√© envoy√© √†<br><strong id="confirmEmail"></strong></p>
                    <p style="margin-top: 16px; font-size: 12px; color: var(--text-dim)">
                        Vous recevrez un rappel la veille.<br>
                        Pour annuler, utilisez le lien dans l'email.
                    </p>
                </div>
                <div class="resa-nav" style="justify-content: center">
                    <button class="btn btn-secondary" onclick="resetWidget()" style="flex: none; padding: 12px 32px">Nouvelle r√©servation</button>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// ============================================================
// CONFIGURATION ‚Äî √Ä MODIFIER AVEC TES VALEURS SUPABASE
// ============================================================
const CONFIG = {
    // Supabase
    SUPABASE_URL: 'https://XXXXX.supabase.co',       // ‚Üê Ton URL Supabase
    SUPABASE_ANON_KEY: 'eyXXXXX',                     // ‚Üê Ta cl√© anon (publique)
    
    // n8n webhook (pour notifications email + restaurant)
    N8N_WEBHOOK_URL: 'https://n8n.ton-domaine.com/webhook/reservation',  // ‚Üê Ton webhook n8n
    
    // Config locale (fallback si Supabase pas encore configur√©)
    MAX_PERSONNES: 10,
    JOURS_AVANCE: 30,
};

// ============================================================
// STATE
// ============================================================
let state = {
    personnes: null,
    date: null,
    heure: null,
    service: null,
    currentMonth: new Date(),
    slots: [],
};

// ============================================================
// SUPABASE CLIENT L√âGER (pas besoin du SDK complet)
// ============================================================
async function supabaseRPC(fnName, params = {}) {
    const res = await fetch(`${CONFIG.SUPABASE_URL}/rest/v1/rpc/${fnName}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'apikey': CONFIG.SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${CONFIG.SUPABASE_ANON_KEY}`,
        },
        body: JSON.stringify(params),
    });
    if (!res.ok) {
        const err = await res.json().catch(() => ({}));
        throw new Error(err.message || `Erreur ${res.status}`);
    }
    return res.json();
}

// ============================================================
// √âTAPE 0 ‚Äî NOMBRE DE PERSONNES
// ============================================================
function initPersonSelector() {
    const container = document.getElementById('personSelector');
    for (let i = 1; i <= CONFIG.MAX_PERSONNES; i++) {
        const btn = document.createElement('button');
        btn.className = 'person-btn';
        btn.textContent = i;
        btn.onclick = () => selectPersonnes(i);
        container.appendChild(btn);
    }
}

function selectPersonnes(n) {
    state.personnes = n;
    document.querySelectorAll('.person-btn').forEach((b, i) => {
        b.classList.toggle('selected', i + 1 === n);
    });
    document.getElementById('btnNext0').disabled = false;
}

// ============================================================
// √âTAPE 1 ‚Äî CALENDRIER
// ============================================================
const MOIS_FR = ['Janvier','F√©vrier','Mars','Avril','Mai','Juin','Juillet','Ao√ªt','Septembre','Octobre','Novembre','D√©cembre'];
const JOURS_FR = ['Lun','Mar','Mer','Jeu','Ven','Sam','Dim'];

function initCalendar() {
    const header = document.getElementById('dayNames');
    header.innerHTML = JOURS_FR.map(j => `<span class="day-name">${j}</span>`).join('');
    renderMonth();
}

function changeMonth(delta) {
    state.currentMonth = new Date(state.currentMonth.getFullYear(), state.currentMonth.getMonth() + delta, 1);
    renderMonth();
}

function renderMonth() {
    const year = state.currentMonth.getFullYear();
    const month = state.currentMonth.getMonth();
    const today = new Date(); today.setHours(0,0,0,0);
    const maxDate = new Date(); maxDate.setDate(maxDate.getDate() + CONFIG.JOURS_AVANCE);
    
    document.getElementById('monthLabel').textContent = `${MOIS_FR[month]} ${year}`;
    
    // Disable prev si on est au mois courant
    const prevBtn = document.getElementById('prevMonth');
    prevBtn.style.visibility = (year === today.getFullYear() && month === today.getMonth()) ? 'hidden' : 'visible';
    
    const grid = document.getElementById('dateGrid');
    grid.innerHTML = '';
    
    const firstDay = new Date(year, month, 1);
    let startDay = firstDay.getDay(); // 0=dimanche
    startDay = startDay === 0 ? 6 : startDay - 1; // Convertir en 0=lundi
    
    // Cases vides avant le 1er
    for (let i = 0; i < startDay; i++) {
        grid.innerHTML += '<div class="date-btn empty"></div>';
    }
    
    const daysInMonth = new Date(year, month + 1, 0).getDate();
    
    for (let d = 1; d <= daysInMonth; d++) {
        const date = new Date(year, month, d);
        const dateStr = formatDate(date);
        const isToday = date.getTime() === today.getTime();
        const isPast = date < today;
        const isTooFar = date > maxDate;
        const isDisabled = isPast || isTooFar;
        const isSelected = state.date === dateStr;
        
        let cls = 'date-btn';
        if (isToday) cls += ' today';
        if (isDisabled) cls += ' disabled';
        if (isSelected) cls += ' selected';
        
        const btn = document.createElement('button');
        btn.className = cls;
        btn.textContent = d;
        if (!isDisabled) {
            btn.onclick = () => selectDate(dateStr);
        }
        grid.appendChild(btn);
    }
}

function formatDate(date) {
    return date.toISOString().split('T')[0];
}

function formatDateFR(dateStr) {
    const d = new Date(dateStr + 'T00:00:00');
    const opts = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' };
    return d.toLocaleDateString('fr-FR', opts);
}

async function selectDate(dateStr) {
    state.date = dateStr;
    state.heure = null;
    state.service = null;
    document.getElementById('btnNext1').disabled = true;
    
    // Update UI
    document.querySelectorAll('.date-btn:not(.empty)').forEach(b => {
        b.classList.toggle('selected', false);
    });
    // Re-render to update selected state
    renderMonth();
    // Highlight selected
    document.querySelectorAll('.date-btn:not(.empty)').forEach(b => {
        if (b.textContent == new Date(dateStr + 'T00:00:00').getDate() ) {
            // Only select if it matches the right month
            const bMonth = state.currentMonth.getMonth();
            const sMonth = new Date(dateStr + 'T00:00:00').getMonth();
            if (bMonth === sMonth) b.classList.add('selected');
        }
    });
    
    // Charger les cr√©neaux
    await loadSlots(dateStr);
}

async function loadSlots(dateStr) {
    const container = document.getElementById('slotsContainer');
    const content = document.getElementById('slotsContent');
    container.style.display = 'block';
    content.innerHTML = '<div class="no-slots">Chargement...</div>';
    
    try {
        const slots = await supabaseRPC('get_disponibilite', { p_date: dateStr });
        state.slots = slots;
        
        if (!slots || slots.length === 0) {
            content.innerHTML = `
                <div class="no-slots">
                    <div style="font-size: 32px; margin-bottom: 8px">üòî</div>
                    Aucun cr√©neau disponible ce jour.<br>
                    <span style="font-size: 12px">Essayez une autre date.</span>
                </div>`;
            return;
        }
        
        // S√©parer midi et soir
        const midi = slots.filter(s => s.service === 'midi');
        const soir = slots.filter(s => s.service === 'soir');
        
        let html = '';
        
        if (midi.length > 0) {
            html += '<div class="service-label">‚òÄÔ∏è Midi</div><div class="time-grid">';
            midi.forEach(s => {
                const heure = s.heure.substring(0, 5);
                const places = s.places_restantes;
                const canBook = places >= state.personnes;
                const isLow = places <= 6 && canBook;
                html += `<button class="time-btn ${!canBook ? 'full' : ''} ${isLow ? 'low' : ''}"
                    ${canBook ? `onclick="selectTime('${heure}', 'midi')"` : ''}
                    ${!canBook ? 'disabled' : ''}>
                    ${heure}
                    <div class="places">${canBook ? places + ' places' : 'Complet'}</div>
                </button>`;
            });
            html += '</div>';
        }
        
        if (soir.length > 0) {
            html += '<div class="service-label">üåô Soir</div><div class="time-grid">';
            soir.forEach(s => {
                const heure = s.heure.substring(0, 5);
                const places = s.places_restantes;
                const canBook = places >= state.personnes;
                const isLow = places <= 6 && canBook;
                html += `<button class="time-btn ${!canBook ? 'full' : ''} ${isLow ? 'low' : ''}"
                    ${canBook ? `onclick="selectTime('${heure}', 'soir')"` : ''}
                    ${!canBook ? 'disabled' : ''}>
                    ${heure}
                    <div class="places">${canBook ? places + ' places' : 'Complet'}</div>
                </button>`;
            });
            html += '</div>';
        }
        
        content.innerHTML = html;
        
    } catch (err) {
        content.innerHTML = `<div class="no-slots">Erreur de chargement. R√©essayez.</div>`;
        console.error('Erreur chargement cr√©neaux:', err);
    }
}

function selectTime(heure, service) {
    state.heure = heure;
    state.service = service;
    document.querySelectorAll('.time-btn').forEach(b => b.classList.remove('selected'));
    // Find and select the right button
    document.querySelectorAll('.time-btn').forEach(b => {
        if (b.textContent.includes(heure) && !b.classList.contains('full')) {
            // Check service match
            const parent = b.closest('.time-grid');
            const label = parent.previousElementSibling;
            if (label && ((service === 'midi' && label.textContent.includes('Midi')) || 
                          (service === 'soir' && label.textContent.includes('Soir')))) {
                b.classList.add('selected');
            }
        }
    });
    document.getElementById('btnNext1').disabled = false;
}

// ============================================================
// NAVIGATION
// ============================================================
function goStep(n) {
    // Validation avant avancer
    if (n === 1 && !state.personnes) return;
    if (n === 2 && (!state.date || !state.heure)) return;
    if (n === 3) {
        if (!validateForm()) return;
        fillRecap();
    }
    
    // Masquer toutes les √©tapes
    document.querySelectorAll('.resa-step').forEach(s => s.classList.remove('active'));
    document.getElementById(`step-${n}`).classList.add('active');
    
    // Update stepper
    for (let i = 0; i < 4; i++) {
        const dot = document.getElementById(`dot-${i}`);
        dot.className = 'step-dot';
        if (i < n) dot.classList.add('done');
        if (i === n) dot.classList.add('active');
    }
    
    hideError();
    
    // Scroll to top of widget
    document.querySelector('.resa-widget').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function validateForm() {
    const prenom = document.getElementById('inputPrenom').value.trim();
    const nom = document.getElementById('inputNom').value.trim();
    const email = document.getElementById('inputEmail').value.trim();
    const tel = document.getElementById('inputTel').value.trim();
    
    if (!prenom || !nom || !email || !tel) {
        showError('Veuillez remplir tous les champs obligatoires.');
        return false;
    }
    if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
        showError('Adresse email invalide.');
        return false;
    }
    if (!/^[\d\s\+\-\.]{8,}$/.test(tel)) {
        showError('Num√©ro de t√©l√©phone invalide.');
        return false;
    }
    return true;
}

function fillRecap() {
    document.getElementById('recapPersonnes').textContent = `${state.personnes} personne${state.personnes > 1 ? 's' : ''}`;
    document.getElementById('recapDate').textContent = formatDateFR(state.date);
    document.getElementById('recapHeure').textContent = `${state.heure} (${state.service})`;
    document.getElementById('recapNom').textContent = `${document.getElementById('inputPrenom').value} ${document.getElementById('inputNom').value}`;
    document.getElementById('recapEmail').textContent = document.getElementById('inputEmail').value;
    document.getElementById('recapTel').textContent = document.getElementById('inputTel').value;
}

// ============================================================
// SOUMISSION
// ============================================================
async function submitReservation() {
    const btn = document.getElementById('btnConfirm');
    btn.disabled = true;
    btn.textContent = 'Envoi en cours...';
    showLoading(true);
    hideError();
    
    const data = {
        p_date: state.date,
        p_heure: state.heure + ':00',
        p_service: state.service,
        p_nombre: state.personnes,
        p_nom: document.getElementById('inputNom').value.trim(),
        p_prenom: document.getElementById('inputPrenom').value.trim(),
        p_email: document.getElementById('inputEmail').value.trim(),
        p_telephone: document.getElementById('inputTel').value.trim(),
        p_commentaire: document.getElementById('inputComment').value.trim(),
        p_allergies: '',
        p_occasion: document.getElementById('inputOccasion').value,
    };
    
    try {
        const result = await supabaseRPC('creer_reservation', data);
        
        if (result && result.success) {
            // Notifier n8n (en arri√®re-plan, on n'attend pas la r√©ponse)
            notifyN8N({
                ...data,
                reservation_id: result.reservation_id,
                token_annulation: result.token_annulation,
            }).catch(e => console.warn('n8n notification failed:', e));
            
            // Afficher confirmation
            document.getElementById('recapView').style.display = 'none';
            document.getElementById('confirmView').style.display = 'block';
            document.getElementById('confirmEmail').textContent = data.p_email;
            
            // Update stepper
            for (let i = 0; i < 4; i++) {
                document.getElementById(`dot-${i}`).className = 'step-dot done';
            }
        } else {
            showError(result?.error || 'Erreur lors de la r√©servation. R√©essayez.');
            btn.disabled = false;
            btn.textContent = '‚úì Confirmer';
        }
    } catch (err) {
        showError('Erreur de connexion. V√©rifiez votre connexion internet.');
        console.error('Erreur soumission:', err);
        btn.disabled = false;
        btn.textContent = '‚úì Confirmer';
    }
    
    showLoading(false);
}

async function notifyN8N(data) {
    if (!CONFIG.N8N_WEBHOOK_URL || CONFIG.N8N_WEBHOOK_URL.includes('ton-domaine')) return;
    
    await fetch(CONFIG.N8N_WEBHOOK_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            event: 'nouvelle_reservation',
            reservation: {
                id: data.reservation_id,
                date: data.p_date,
                heure: data.p_heure,
                service: data.p_service,
                personnes: data.p_nombre,
                nom: data.p_nom,
                prenom: data.p_prenom,
                email: data.p_email,
                telephone: data.p_telephone,
                commentaire: data.p_commentaire,
                occasion: data.p_occasion,
                token_annulation: data.token_annulation,
            },
            timestamp: new Date().toISOString(),
        }),
    });
}

// ============================================================
// UTILS
// ============================================================
function showError(msg) {
    const el = document.getElementById('errorMsg');
    el.textContent = msg;
    el.classList.add('visible');
}
function hideError() {
    document.getElementById('errorMsg').classList.remove('visible');
}
function showLoading(show) {
    document.getElementById('loadingOverlay').classList.toggle('visible', show);
}

function resetWidget() {
    state = { personnes: null, date: null, heure: null, service: null, currentMonth: new Date(), slots: [] };
    
    document.querySelectorAll('.person-btn').forEach(b => b.classList.remove('selected'));
    document.getElementById('btnNext0').disabled = true;
    document.getElementById('btnNext1').disabled = true;
    document.getElementById('slotsContainer').style.display = 'none';
    document.getElementById('recapView').style.display = 'block';
    document.getElementById('confirmView').style.display = 'none';
    document.getElementById('btnConfirm').disabled = false;
    document.getElementById('btnConfirm').textContent = '‚úì Confirmer';
    
    // Reset form
    ['inputPrenom','inputNom','inputEmail','inputTel','inputComment'].forEach(id => {
        document.getElementById(id).value = '';
    });
    document.getElementById('inputOccasion').value = '';
    
    renderMonth();
    goStep(0);
}

// ============================================================
// INIT
// ============================================================
document.addEventListener('DOMContentLoaded', () => {
    initPersonSelector();
    initCalendar();
});
</script>
</body>
</html>
